import requests
import json
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

BASE_ALERTS_URL = "http://ubilling.net.ua/aerialalerts/"

def get_air_raid_status(region):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

    Args:
        region (str): –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞.

    Returns:
        str or None: –°—Ç–∞—Ç—É—Å —Ç—Ä–µ–≤–æ–≥–∏ ("–¢—Ä–∏–≤–æ–≥–∞", "–í—ñ–¥–±—ñ–π") –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–≥–∏–æ–Ω–∞.
    """
    logging.info(f"–ó–∞–ø—Ä–æ—à–µ–Ω —Å—Ç–∞—Ç—É—Å —Ç—Ä–µ–≤–æ–≥–∏ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞: '{region}'")
    try:
        response = requests.get(BASE_ALERTS_URL)
        response.raise_for_status()
        raw_json = response.text
        logging.info(f"–ü–æ–ª—É—á–µ–Ω JSON –æ—Ç API: {raw_json}")
        data = json.loads(raw_json)
        if 'states' in data:
            for state_name, state_params in data['states'].items():
                logging.info(f"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: API —Ä–µ–≥–∏–æ–Ω '{state_name.lower()}' —Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º '{region.lower()}'")
                if state_name.lower() == region.lower():
                    if state_params['alertnow']:
                        return "–¢—Ä–∏–≤–æ–≥–∞"
                    else:
                        return "–í—ñ–¥–±—ñ–π"
        else:
            logging.warning("–ö–ª—é—á 'states' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ JSON-–æ—Ç–≤–µ—Ç–µ.")
        return None  # –†–µ–≥–∏–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
    except requests.exceptions.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API —Ç—Ä–µ–≤–æ–≥: {e}")
        return None
    except json.JSONDecodeError as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ JSON –æ—Ç API —Ç—Ä–µ–≤–æ–≥: {e}")
        return None

def format_air_raid_message(region, status):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏.

    Args:
        region (str): –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞.
        status (str): –°—Ç–∞—Ç—É—Å —Ç—Ä–µ–≤–æ–≥–∏.

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    if status == "–¢—Ä–∏–≤–æ–≥–∞":
        return f"üö® –í–Ω–∏–º–∞–Ω–∏–µ! –í —Ä–µ–≥–∏–æ–Ω–µ '{region}' –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤–æ–∑–¥—É—à–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞!"
    elif status == "–í—ñ–¥–±—ñ–π":
        return f"‚úÖ –í —Ä–µ–≥–∏–æ–Ω–µ '{region}' –æ—Ç–±–æ–π –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏."
    else:
        return f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞ '{region}'."